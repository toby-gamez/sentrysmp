<!doctype html>
<html>
    <head>
        <!-- Google Consent Mode -->
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag() {
                dataLayer.push(arguments);
            }

            // Default state: consent denied if no choice is stored
            if (!localStorage.getItem("cookies-accepted")) {
                gtag("consent", "default", {
                    analytics_storage: "denied",
                });
            } else {
                gtag("consent", "update", {
                    analytics_storage:
                        localStorage.getItem("cookies-accepted") === "granted"
                            ? "granted"
                            : "denied",
                });
            }
        </script>
        <!-- Google Analytics (won't load automatically) -->
        <script
            async
            src="https://www.googletagmanager.com/gtag/js?id=G-SGG2CLM06D"
        ></script>
        <script>
            function loadGoogleAnalytics() {
                gtag("js", new Date());
                gtag("config", "G-SGG2CLM06D");
            }

            // Function to show/hide cookie banner
            function showCookieBanner() {
                if (!localStorage.getItem("cookies-accepted")) {
                    document.getElementById("cookie-banner").style.display =
                        "flex";
                } else {
                    document.getElementById("cookie-banner").style.display =
                        "none";
                    if (
                        localStorage.getItem("cookies-accepted") === "granted"
                    ) {
                        loadGoogleAnalytics();
                    }
                }
            }

            // Function to accept cookies
            function acceptCookies() {
                localStorage.setItem("cookies-accepted", "granted");
                document.getElementById("cookie-banner").style.display = "none";
                gtag("consent", "update", {
                    analytics_storage: "granted",
                });
                loadGoogleAnalytics();
            }

            // Function to decline cookies
            function declineCookies() {
                localStorage.setItem("cookies-accepted", "denied");
                document.getElementById("cookie-banner").style.display = "none";
                gtag("consent", "update", {
                    analytics_storage: "denied",
                });
            }

            // Show cookie banner after page loads
            window.addEventListener("DOMContentLoaded", showCookieBanner);
        </script>
        <!-- SEO meta tags for Google -->
        <meta
            name="description"
            content="SentrySMP is a Minecraft server focused on providing a safe and enjoyable experience for players of all ages. It is SMP with addons."
        />
        <meta
            name="keywords"
            content="Minecraft, SMP, English, Czech, server, safe, enjoyable, experience, players, vip, premium, exclusive"
        />
        <meta name="author" content="Sentry SMP" />

        <!-- Open Graph for Facebook, Discord, etc. -->
        <meta property="og:title" content="Sentry SMP" />
        <meta
            property="og:description"
            content="Sentry SMP server is a Minecraft server focused on providing a safe and enjoyable experience for players of all ages. It is SMP with addons."
        />
        <meta
            property="og:image"
            content="https://sentrysmp.eu/images/logo.png"
        />
        <meta property="og:url" content="https://sentrysmp.eu/" />
        <meta property="og:type" content="website" />

        <!-- Twitter Cards (optional) -->
        <meta name="twitter:card" content="summary_large_image" />
        <meta name="twitter:title" content="Sentry SMP" />
        <meta
            name="twitter:description"
            content="Sentry SMP server is a Minecraft server focused on providing a safe and enjoyable experience for players of all ages. It is SMP with addons."
        />
        <meta
            name="twitter:image"
            content="https://sentrysmp.eu/images/logo.png"
        />
        <!-- Language settings -->
        <meta http-equiv="content-language" content="en" />
        <meta name="language" content="English" />

        <title>Cart - Sentry SMP</title>
        <meta charset="utf-8" />
        <link rel="stylesheet" href="css/style.css" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="icon" href="images/favicon.png" />
        <style>
            body.dark .header-background {
                background-image: url("images/background-image-dark.png");
            }

            body:not(.dark) .header-background {
                background-image: url("images/background-image.png");
            }
        </style>
    </head>
    <body>
        <nav class="navbar" id="navbar-main"></nav>
        <div id="cookie-banner" style="display: none"></div>

        <header id="header-main"></header>
        <div class="container">
            <div class="main-wrapper">
                <h1 class="main">Cart</h1>
            </div>

            <div id="notification-container"></div>
            <div class="info">
                <p>
                    To receive your purchase, you must be connected to the
                    Survival server.
                    <b
                        >Being in the lobby or another our server is not
                        enough!</b
                    >
                </p>
            </div>
            <div class="cart-buttons">
                <button class="empty-btn danger" onclick="emptyCart()">
                    Empty Cart
                </button>
                <button
                    class="checkout-btn"
                    onclick="location.href='checkout.php'"
                >
                    Proceed to Checkout
                </button>
            </div>
            <div id="cart-summary" style="display: none">
                <div id="cart-items-summary"></div>
                <div id="cart-discount-summary"></div>
                <div class="cart-total">
                    Total: <span id="cart-total-amount">€0.00</span>
                </div>
            </div>

            <div id="cart-list" class="spawner-grid"></div>

            <div
                id="empty-cart-message"
                class="empty-cart-message"
                style="display: none"
            >
                Your cart is empty. <a href="home">Continue shopping</a>
            </div>
        </div>
        <footer id="footer-main"></footer>
        <script src="js/script.js"></script>
        <script>
            let notificationContainer;

            function createNotificationContainer() {
                if (!notificationContainer) {
                    notificationContainer = document.createElement("div");
                    notificationContainer.className = "notification-container";
                    document.body.appendChild(notificationContainer);
                }
                return notificationContainer;
            }

            // Show notification with auto-dismiss timer
            function showNotification(
                message,
                type = "success",
                duration = 5000,
            ) {
                createNotificationContainer();

                // Check for duplicate notifications already showing
                const existingNotifications = document.querySelectorAll(
                    ".notification .message",
                );
                for (const existing of existingNotifications) {
                    if (existing.innerHTML === message.replace(/\n/g, "<br>")) {
                        console.log(
                            "Duplicate notification prevented:",
                            message,
                        );
                        return null; // Don't show duplicate notifications
                    }
                }

                // Create notification element
                const notification = document.createElement("div");
                notification.className = "notification " + type;

                // Create message content
                const messageEl = document.createElement("div");
                messageEl.className = "message";
                messageEl.innerHTML = message.replace(/\n/g, "<br>");
                notification.appendChild(messageEl);

                // Add close button
                const closeBtn = document.createElement("span");
                closeBtn.className = "close-btn";
                closeBtn.innerHTML = "&times;";
                closeBtn.onclick = () => removeNotification(notification);
                notification.appendChild(closeBtn);

                // Add timer bar
                const timerBar = document.createElement("div");
                timerBar.className = "timer-bar";
                notification.appendChild(timerBar);

                // Add to container
                notificationContainer.appendChild(notification);

                // Animate timer
                const startTime = Date.now();
                const timerInterval = setInterval(() => {
                    const elapsedTime = Date.now() - startTime;
                    const remainingPercent =
                        100 - (elapsedTime / duration) * 100;

                    if (remainingPercent <= 0) {
                        clearInterval(timerInterval);
                        removeNotification(notification);
                    } else {
                        timerBar.style.width = remainingPercent + "%";
                    }
                }, 50);

                // Store interval ID for cleanup
                notification.dataset.intervalId = timerInterval;

                return notification;
            }

            // Remove notification with animation
            function removeNotification(notification) {
                // Clear the timer interval
                clearInterval(notification.dataset.intervalId);

                // Animate out
                notification.style.animation = "fadeOut 0.3s forwards";

                // Remove after animation
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }

                    // Remove container if empty
                    if (
                        notificationContainer &&
                        notificationContainer.children.length === 0
                    ) {
                        document.body.removeChild(notificationContainer);
                        notificationContainer = null;
                    }
                }, 300);
            }

            function validateQuantity(input) {
                // Store the original value for logging
                const originalValue = input.value;

                // Ensure quantity is at least 1
                if (input.value < 1) {
                    input.value = 1;
                }
                // Restrict to whole numbers
                input.value = Math.floor(input.value);

                // Log the change and give visual feedback if value changed
                if (originalValue != input.value) {
                    console.log(
                        `Quantity adjusted from ${originalValue} to ${input.value}`,
                    );
                    // Add brief highlight effect
                    input.style.backgroundColor = "#ffff99";
                    setTimeout(() => {
                        input.style.backgroundColor = "";
                    }, 500);
                }

                // Find the parent cart item
                const cartItem = input.closest(".cart-item");
                if (cartItem) {
                    const itemId = cartItem.getAttribute("data-id");
                    const updateButton = cartItem.querySelector(".update-btn");

                    if (updateButton) {
                        updateButton.style.display = "block";
                        updateButton.disabled = false;
                    }

                    // Update the subtotal for this item
                    updateItemSubtotal(cartItem);
                }

                // Update overall cart total
                updateCartTotal();
            }

            function adjustQuantity(button, delta) {
                try {
                    // Find input element
                    const input = button.parentNode.querySelector(
                        "input.item-quantity",
                    );
                    if (!input) {
                        console.error("Quantity input not found");
                        return;
                    }

                    // Convert values to numbers
                    const oldValue = parseInt(input.value || "1");
                    delta = parseInt(delta);

                    // Calculate new value
                    let newValue = oldValue + delta;
                    if (newValue < 1) newValue = 1;

                    // Set new value
                    input.value = newValue;

                    // Log for debug
                    console.log(
                        `Quantity changed: ${oldValue} -> ${newValue} (${delta > 0 ? "increased" : "decreased"})`,
                    );

                    // Visual feedback
                    input.style.backgroundColor = "#ffff99";
                    setTimeout(() => {
                        input.style.backgroundColor = "";
                    }, 500);

                    // Display a small floating indicator
                    const indicator = document.createElement("span");
                    indicator.textContent = delta > 0 ? "+" + delta : delta;
                    indicator.style.position = "absolute";
                    indicator.style.background =
                        delta > 0 ? "#4CAF50" : "#f44336";
                    indicator.style.color = "white";
                    indicator.style.borderRadius = "50%";
                    indicator.style.width = "20px";
                    indicator.style.height = "20px";
                    indicator.style.textAlign = "center";
                    indicator.style.lineHeight = "20px";
                    indicator.style.fontSize = "12px";
                    indicator.style.opacity = "0.9";
                    indicator.style.transition = "all 0.5s ease-out";

                    const buttonRect = button.getBoundingClientRect();
                    indicator.style.left =
                        buttonRect.left + buttonRect.width / 2 + "px";
                    indicator.style.top = buttonRect.top + "px";
                    document.body.appendChild(indicator);

                    // Animate and remove
                    setTimeout(() => {
                        indicator.style.transform = "translateY(-20px)";
                        indicator.style.opacity = "0";
                        setTimeout(
                            () => document.body.removeChild(indicator),
                            500,
                        );
                    }, 10);

                    // Find the parent cart item and show update button
                    const cartItem = button.closest(".cart-item");
                    if (cartItem) {
                        const updateButton =
                            cartItem.querySelector(".update-btn");
                        if (updateButton) {
                            updateButton.style.display = "block";
                            updateButton.disabled = false;
                        }

                        // Update the subtotal for this item
                        updateItemSubtotal(cartItem);
                    }

                    // Update overall cart total
                    updateCartTotal();
                } catch (error) {
                    console.error("Error in adjustQuantity:", error);
                }
            }

            function updateItemSubtotal(cartItem) {
                try {
                    const quantityInput = cartItem.querySelector(
                        "input.item-quantity",
                    );
                    const quantity = parseInt(quantityInput?.value || 1);

                    // Get price (try multiple locations)
                    // Get price
                    let price = 0;
                    const priceContainer =
                        cartItem.querySelector(".price-container");

                    if (priceContainer) {
                        // Try to get discounted price first
                        const discountedElement =
                            priceContainer.querySelector(".discounted-price");
                        if (discountedElement) {
                            const priceMatch =
                                discountedElement.textContent.match(
                                    /(\d+(?:\.\d+)?)€/,
                                );
                            if (priceMatch) {
                                price = parseFloat(priceMatch[1]);
                            }
                        } else {
                            // If no discount, get original price
                            const originalPriceElement =
                                priceContainer.querySelector(".original-price");
                            if (originalPriceElement) {
                                const priceMatch =
                                    originalPriceElement.textContent.match(
                                        /(\d+(?:\.\d+)?)€/,
                                    );
                                if (priceMatch) {
                                    price = parseFloat(priceMatch[1]);
                                }
                            }
                        }
                    }

                    // If price still not found, check description
                    if (price === 0) {
                        const description = cartItem.querySelector("p");
                        if (description) {
                            const priceMatch =
                                description.textContent.match(
                                    /(\d+(?:\.\d+)?)€/,
                                );
                            if (priceMatch) {
                                price = parseFloat(priceMatch[1]);
                            }
                        }
                    }

                    // Fallback price if all else fails
                    if (price === 0) {
                        price = 3; // Default price
                    }

                    // Update subtotal - ensure we're using discounted price
                    const subtotalElement =
                        cartItem.querySelector(".item-subtotal");
                    if (subtotalElement) {
                        const subtotal = price * quantity;
                        subtotalElement.textContent = `€${Number(subtotal).toLocaleString("en", { minimumFractionDigits: 0, maximumFractionDigits: 2 })}`;
                        subtotalElement.style.color = "#e74c3c";
                        subtotalElement.style.fontWeight = "bold";
                        subtotalElement.style.fontSize = "1.3em";
                    }
                } catch (error) {
                    console.error("Error updating item subtotal:", error);
                }
            }

            function updateCartTotal() {
                try {
                    let total = 0;
                    const cartItems = document.querySelectorAll(".cart-item");

                    // Přepočítat total přímo z localStorage (price * quantity pro každou položku)
                    let cartData = [];
                    try {
                        cartData = JSON.parse(
                            localStorage.getItem("cart") || "[]",
                        );
                    } catch (e) {
                        cartData = [];
                    }
                    if (
                        cartData.length > 0 &&
                        typeof cartData[0] === "object"
                    ) {
                        cartData.forEach((item) => {
                            let price = parseFloat(item.price) || 0;
                            let quantity = parseInt(item.quantity) || 1;
                            total += price * quantity;
                        });
                    }

                    // Update total display
                    const totalElement =
                        document.getElementById("cart-total-amount");
                    if (totalElement) {
                        // Format total with only necessary decimal places (no trailing zeros)
                        totalElement.textContent = `€${Number(total).toLocaleString("en", { minimumFractionDigits: 0, maximumFractionDigits: 2 })}`;
                    }

                    return total;
                } catch (error) {
                    console.error("Error updating cart total:", error);
                    return 0;
                }
            }

            function updateCartItem(itemId) {
                try {
                    const cartItem = document.querySelector(
                        `.cart-item[data-id="${itemId}"]`,
                    );
                    if (!cartItem) {
                        console.error("Cart item not found:", itemId);
                        return;
                    }

                    const quantityInput = cartItem.querySelector(
                        "input.item-quantity",
                    );
                    const quantity = parseInt(quantityInput?.value || 1);

                    // Get the cart from localStorage
                    let cart = JSON.parse(localStorage.getItem("cart") || "[]");

                    // Find the item in the cart
                    const itemIndex = cart.findIndex(
                        (item) => String(item.id) === String(itemId),
                    );

                    if (itemIndex !== -1) {
                        // Update quantity
                        cart[itemIndex].quantity = quantity;

                        // Save back to localStorage
                        localStorage.setItem("cart", JSON.stringify(cart));

                        // Update the button
                        const updateButton =
                            cartItem.querySelector(".update-btn");
                        if (updateButton) {
                            updateButton.style.display = "none";

                            // Show notification
                            showNotification(
                                `Quantity updated to ${quantity}`,
                                "success",
                            );
                        }

                        // Update cart count in navbar
                        updateCartCount();
                    }
                } catch (error) {
                    console.error("Error updating cart item:", error);
                    showNotification("Error updating item", "error");
                }
            }

            function removeFromCart(itemId) {
                try {
                    // Get the cart from localStorage
                    let cart = JSON.parse(localStorage.getItem("cart") || "[]");

                    // Store initial cart state for validation
                    const initialCartLength = cart.length;

                    // Handle both old and new cart formats
                    if (
                        Array.isArray(cart) &&
                        cart.length > 0 &&
                        typeof cart[0] !== "object"
                    ) {
                        // Old format - simple array of IDs
                        cart = cart.filter(
                            (id) => String(id) !== String(itemId),
                        );
                    } else {
                        // New format - array of objects with id and quantity
                        cart = cart.filter(
                            (item) => String(item.id) !== String(itemId),
                        );
                    }

                    // Verify item was actually removed
                    if (cart.length === initialCartLength) {
                        console.warn(
                            `Item with ID ${itemId} was not found in cart.`,
                        );
                        // Skip further processing since nothing changed
                        return;
                    }

                    // Save back to localStorage
                    localStorage.setItem("cart", JSON.stringify(cart));

                    // Show notification
                    showNotification("Item removed from cart", "success");

                    // Re-render the cart immediately to update display
                    renderCart();

                    // Update cart count in navbar
                    updateCartCount();

                    // Update checkout button
                    updateCheckoutButtonVisibility();

                    // Return true to indicate successful removal
                    return true;
                } catch (error) {
                    console.error("Error removing item from cart:", error);
                    showNotification("Error removing item", "error");
                    return false;
                }
            }

            function emptyCart() {
                // Get the cart from localStorage
                const cart = JSON.parse(localStorage.getItem("cart") || "[]");

                if (cart.length === 0) {
                    showNotification("Cart is already empty", "warning");
                    return;
                }

                if (confirm("Are you sure you want to empty your cart?")) {
                    // Clear the cart in localStorage
                    localStorage.setItem("cart", "[]");

                    // Show notification
                    showNotification("Cart emptied successfully", "success");

                    // Re-render the cart
                    renderCart();

                    // Update cart count in navbar
                    updateCartCount();

                    // Update checkout button visibility
                    updateCheckoutButtonVisibility();
                }
            }

            function updateCartCount() {
                try {
                    const cart = JSON.parse(
                        localStorage.getItem("cart") || "[]",
                    );
                    let count = 0;

                    // Count total items in cart
                    cart.forEach((item) => {
                        count += parseInt(item.quantity || 1);
                    });

                    // Update UI elements showing cart count
                    const cartCountElements =
                        document.querySelectorAll(".cart-count");
                    cartCountElements.forEach((element) => {
                        element.textContent = count;

                        // Show/hide based on count
                        if (count > 0) {
                            element.style.display = "flex";
                        } else {
                            element.style.display = "none";
                        }
                    });

                    return count;
                } catch (error) {
                    console.error("Error updating cart count:", error);
                    return 0;
                }
            }

            function renderCart() {
                try {
                    const cartListElement =
                        document.getElementById("cart-list");
                    const cartSummaryElement =
                        document.getElementById("cart-summary");
                    const emptyCartMessageElement =
                        document.getElementById("empty-cart-message");

                    // Clear existing content
                    cartListElement.innerHTML = "";

                    // Get cart from localStorage
                    const cart = JSON.parse(
                        localStorage.getItem("cart") || "[]",
                    );

                    if (cart.length === 0) {
                        // Show empty cart message
                        cartSummaryElement.style.display = "none";
                        emptyCartMessageElement.style.display = "block";
                        return;
                    }

                    // Hide empty cart message
                    emptyCartMessageElement.style.display = "none";

                    // Process each item in the cart
                    const pendingItems = [];
                    let totalItems = 0;

                    // Only process regular items (VIP logic removed)
                    if (Array.isArray(cart) && cart.length > 0 && !cart[0].id) {
                        // Old format - simple array of IDs
                        cart.forEach((id) => {
                            // Only push non-VIP items (VIP logic removed)
                            pendingItems.push({ id });
                            totalItems += 1;
                        });
                    } else {
                        // New format - array of objects with id and quantity
                        cart.forEach((item) => {
                            // Only push non-VIP items (VIP logic removed)
                            pendingItems.push(item);
                            totalItems += parseInt(item.quantity || 1);
                        });
                    }

                    // If we have no regular items, we're done
                    if (pendingItems.length === 0) {
                        cartSummaryElement.style.display = "none";
                        emptyCartMessageElement.style.display = "block";
                        return;
                    }

                    updateCartTotal();

                    // First fetch details from keys.php
                    fetchItemsFromSource("keys.php")
                        .then((keysItems) => {
                            // Then fetch from battlepasses.php
                            fetchItemsFromSource("battlepasses.php")
                                .then((battlepassItems) => {
                                    // Then fetch from shards.php
                                    fetchItemsFromSource("shards.php")
                                        .then((spawnerItems) => {
                                            // Then fetch from ranks.php
                                            fetchItemsFromSource("ranks.php")
                                                .then((rankItems) => {
                                                    // Combine items from all sources
                                                    const allItems = [
                                                        ...keysItems,
                                                        ...battlepassItems,
                                                        ...spawnerItems,
                                                        ...rankItems,
                                                    ];

                                                    console.log(
                                                        "Processing items:",
                                                        {
                                                            pendingItems:
                                                                pendingItems,
                                                            allItemsCount:
                                                                allItems.length,
                                                            allItemIds:
                                                                allItems.map(
                                                                    (el) =>
                                                                        el.getAttribute(
                                                                            "data-id",
                                                                        ),
                                                                ),
                                                        },
                                                    );

                                                    // Process each pending item
                                                    pendingItems.forEach(
                                                        (item) => {
                                                            let id = String(
                                                                item.id,
                                                            );

                                                            console.log(
                                                                `Looking for item with ID: ${id} (original: ${item.id}) in ${allItems.length} items`,
                                                            );

                                                            // First try exact match
                                                            let matchingItem =
                                                                allItems.find(
                                                                    (el) =>
                                                                        el.getAttribute(
                                                                            "data-id",
                                                                        ) ===
                                                                        id,
                                                                );

                                                            // If no match found, try with/without quotes
                                                            if (!matchingItem) {
                                                                console.log(
                                                                    `No exact match for ID ${id}, trying alternative formats`,
                                                                );
                                                                matchingItem =
                                                                    allItems.find(
                                                                        (
                                                                            el,
                                                                        ) => {
                                                                            const elId =
                                                                                el.getAttribute(
                                                                                    "data-id",
                                                                                );
                                                                            return (
                                                                                elId ===
                                                                                    `"${id}"` ||
                                                                                elId ===
                                                                                    `'${id}'` ||
                                                                                id ===
                                                                                    `"${elId}"` ||
                                                                                id ===
                                                                                    `'${elId}'` ||
                                                                                elId ===
                                                                                    id.replace(
                                                                                        /['"]/g,
                                                                                        "",
                                                                                    )
                                                                            );
                                                                        },
                                                                    );
                                                            }

                                                            if (matchingItem) {
                                                                console.log(
                                                                    `Found matching item for ID ${id}:`,
                                                                    matchingItem.outerHTML,
                                                                );

                                                                // Create cart item
                                                                const cartItem =
                                                                    document.createElement(
                                                                        "div",
                                                                    );
                                                                cartItem.className =
                                                                    "cart-item";
                                                                // Store the original ID (with possible rank_ prefix)
                                                                cartItem.setAttribute(
                                                                    "data-id",
                                                                    id,
                                                                );
                                                                // Also store type for debugging
                                                                if (item.type) {
                                                                    cartItem.setAttribute(
                                                                        "data-type",
                                                                        item.type,
                                                                    );
                                                                }

                                                                // Extract item details with safeguards
                                                                const nameElement =
                                                                    matchingItem.querySelector(
                                                                        "h2",
                                                                    );
                                                                const name =
                                                                    nameElement?.textContent?.trim() ||
                                                                    `Item ${id}`;

                                                                console.log(
                                                                    `Extracted name: "${name}" from element:`,
                                                                    nameElement?.outerHTML,
                                                                );

                                                                // Get clean description without price
                                                                const descElement =
                                                                    matchingItem.querySelector(
                                                                        "p",
                                                                    );
                                                                let description =
                                                                    descElement?.textContent ||
                                                                    "";

                                                                // Get image if available
                                                                const imgElement =
                                                                    matchingItem.querySelector(
                                                                        "img",
                                                                    );
                                                                const imgSrc =
                                                                    imgElement?.getAttribute(
                                                                        "src",
                                                                    ) ||
                                                                    "images/image.png";

                                                                console.log(
                                                                    "Found item:",
                                                                    {
                                                                        id: id,
                                                                        name: name,
                                                                        hasImage:
                                                                            !!imgSrc,
                                                                        matchingItem:
                                                                            matchingItem.outerHTML,
                                                                    },
                                                                );

                                                                // Check if the item has a discount
                                                                let priceHtml =
                                                                    "";
                                                                let price =
                                                                    item.price ||
                                                                    3;
                                                                const priceContainer =
                                                                    matchingItem.querySelector(
                                                                        ".price-container",
                                                                    );

                                                                if (
                                                                    priceContainer
                                                                ) {
                                                                    // Extract price from discounted or original price
                                                                    const discountedElement =
                                                                        priceContainer.querySelector(
                                                                            ".discounted-price",
                                                                        );
                                                                    const originalPriceElement =
                                                                        priceContainer.querySelector(
                                                                            ".original-price",
                                                                        );

                                                                    if (
                                                                        discountedElement &&
                                                                        originalPriceElement
                                                                    ) {
                                                                        // Item has discount - show both prices
                                                                        const discountedPriceMatch =
                                                                            discountedElement.textContent.match(
                                                                                /(\d+(?:\.\d+)?)/,
                                                                            );
                                                                        const originalPriceMatch =
                                                                            originalPriceElement.textContent.match(
                                                                                /(\d+(?:\.\d+)?)/,
                                                                            );

                                                                        if (
                                                                            discountedPriceMatch &&
                                                                            originalPriceMatch
                                                                        ) {
                                                                            const discountedPrice =
                                                                                parseFloat(
                                                                                    discountedPriceMatch[1],
                                                                                );
                                                                            const originalPrice =
                                                                                parseFloat(
                                                                                    originalPriceMatch[1],
                                                                                );
                                                                            price =
                                                                                discountedPrice;

                                                                            priceHtml = `<div class="price-container">
                                                                    <p class="original-price" style="text-decoration: line-through;">€${originalPrice}</p>
                                                                    <p class="discounted-price">€${discountedPrice}</p>
                                                                </div>`;
                                                                        } else {
                                                                            price =
                                                                                parseFloat(
                                                                                    discountedPriceMatch[1],
                                                                                ) ||
                                                                                price;
                                                                            priceHtml = `<div class="price-container"><p class="discounted-price">€${price}</p></div>`;
                                                                        }
                                                                    } else if (
                                                                        discountedElement
                                                                    ) {
                                                                        // Only discounted price exists
                                                                        const priceMatch =
                                                                            discountedElement.textContent.match(
                                                                                /(\d+(?:\.\d+)?)/,
                                                                            );
                                                                        if (
                                                                            priceMatch
                                                                        ) {
                                                                            price =
                                                                                parseFloat(
                                                                                    priceMatch[1],
                                                                                );
                                                                        }
                                                                        priceHtml = `<div class="price-container"><p class="discounted-price">€${price}</p></div>`;
                                                                    } else if (
                                                                        originalPriceElement
                                                                    ) {
                                                                        // Only original price exists
                                                                        const priceMatch =
                                                                            originalPriceElement.textContent.match(
                                                                                /(\d+(?:\.\d+)?)/,
                                                                            );
                                                                        if (
                                                                            priceMatch
                                                                        ) {
                                                                            price =
                                                                                parseFloat(
                                                                                    priceMatch[1],
                                                                                );
                                                                        }
                                                                        priceHtml = `<div class="price-container"><p class="discounted-price">€${price}</p></div>`;
                                                                    } else {
                                                                        // No price elements found in container
                                                                        priceHtml = `<div class="price-container"><p class="discounted-price">€${price}</p></div>`;
                                                                    }
                                                                } else {
                                                                    // Extract price from description if available
                                                                    if (
                                                                        description
                                                                    ) {
                                                                        const priceMatch =
                                                                            description.match(
                                                                                /(\d+(?:\.\d+)?)/,
                                                                            );
                                                                        if (
                                                                            priceMatch
                                                                        ) {
                                                                            price =
                                                                                parseFloat(
                                                                                    priceMatch[1],
                                                                                );
                                                                        }
                                                                    }

                                                                    // Create simple price display with new format
                                                                    priceHtml = `<div class="price-container"><p class="discounted-price">€${price}</p></div>`;
                                                                }

                                                                // Check if this is a rank item
                                                                const isRankItem =
                                                                    id.startsWith(
                                                                        "rank_",
                                                                    );

                                                                // Build cart item HTML with image if available
                                                                if (
                                                                    isRankItem
                                                                ) {
                                                                    // For rank items - no quantity controls
                                                                    cartItem.innerHTML = `
                                                 <img src="${imgSrc}" class="item-image" alt="image">
                                                 <div class="cart-details">
                                                     <div>
                                                         <h2>${name || "Unknown Item"}</h2>
                                                         ${priceHtml}
                                                     </div>
                                                 </div>
                                                 <div class="price-container">
                                                 <p class="item-subtotal" style="color: #e74c3c; font-weight: bold; font-size: 1.3em;">€${Number(price).toLocaleString("en", { minimumFractionDigits: 0, maximumFractionDigits: 2 })}</p>
                                             </div>
                                                 <div class="cart-actions">
                                                    <button class="remove-btn danger" onclick="removeFromCart('${id}')">Remove</button>
                                                 </div>
                                            `;
                                                                } else {
                                                                    // For other items - with quantity controls
                                                                    cartItem.innerHTML = `
                                                 <img src="${imgSrc}" class="item-image" alt="image">
                                                 <div class="cart-details">
                                                     <div>
                                                         <h2>${name || "Unknown Item"}</h2>
                                                         ${priceHtml}
                                                     </div>
                                                 </div>
                                                 <div class="price-container">
                                                 <p class="item-subtotal" style="color: #e74c3c; font-weight: bold; font-size: 1.3em;">€${Number(price * (item.quantity || 1)).toLocaleString("en", { minimumFractionDigits: 0, maximumFractionDigits: 2 })}</p>
                                             </div>
                                                 <div class="quantity-controls">
                                                    <button type="button" class="quantity-btn minus" onclick="adjustQuantity(this, -1)" title="Decrease quantity">-</button>
                                                    <input type="number" class="item-quantity" value="${item.quantity || 1}" min="1" onchange="validateQuantity(this)" oninput="validateQuantity(this)">
                                                    <button type="button" class="quantity-btn plus" onclick="adjustQuantity(this, 1)" title="Increase quantity">+</button>
                                                 </div>
                                                 <div class="cart-actions">
                                                    <button class="remove-btn danger" onclick="removeFromCart('${id}')">Remove</button>
                                                    <button class="update-btn" style="display: none;" onclick="updateCartItem('${id}')">Update Quantity</button>
                                                 </div>
                                            `;
                                                                }

                                                                cartListElement.appendChild(
                                                                    cartItem,
                                                                );
                                                            }
                                                        },
                                                    );

                                                    // Show summary if we have items
                                                    cartSummaryElement.style.display =
                                                        "block";

                                                    // Update cart total
                                                    updateCartTotal();
                                                })
                                                .catch(handleFetchError);
                                        })
                                        .catch(handleFetchError);
                                })
                                .catch(handleFetchError);
                        })
                        .catch(handleFetchError);
                } catch (error) {
                    console.error("Error rendering cart:", error);
                    showNotification("Error displaying cart", "error");
                }
            }

            function fetchItemsFromSource(source) {
                console.log(`Fetching items from ${source}...`);
                return fetch(source)
                    .then((response) => {
                        if (!response.ok) {
                            throw new Error(
                                `Failed to fetch from ${source}: ${response.status}`,
                            );
                        }
                        return response.text();
                    })
                    .then((html) => {
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, "text/html");
                        // We're looking for spawners in all sources now
                        const itemSelector = ".spawner";
                        const items = Array.from(
                            doc.querySelectorAll(itemSelector),
                        );

                        // Log each item's details for debugging
                        items.forEach((item) => {
                            const itemId = item.getAttribute("data-id");
                            const name = item
                                .querySelector("h2")
                                ?.textContent?.trim();
                            const hasImage = !!item.querySelector("img");
                            console.log(
                                `Item from ${source}: ID=${itemId}, Name=${name}, HasImage=${hasImage}`,
                            );
                        });

                        console.log(
                            `Loaded ${items.length} items from ${source}`,
                        );
                        return items;
                    });
            }

            function handleFetchError(error) {
                console.error("Error fetching item details:", error);
                showNotification("Error loading cart items", "error");
            }

            function addDirectFetchedItemToCart(itemData, id) {
                try {
                    // Find the cart container
                    const cartListElement =
                        document.getElementById("cart-list");
                    if (!cartListElement) return;

                    // Get item details from localStorage
                    const cart = JSON.parse(
                        localStorage.getItem("cart") || "[]",
                    );
                    const cartItem = cart.find(
                        (item) => String(item.id) === String(id),
                    );
                    if (!cartItem) return;

                    // Create cart item element
                    const cartItemElement = document.createElement("div");
                    cartItemElement.className = "cart-item";
                    cartItemElement.setAttribute("data-id", id);

                    // Get quantity and price
                    const quantity = cartItem.quantity || 1;
                    const price = cartItem.price || itemData.price || 3;

                    // Create price HTML
                    let priceHtml = "";
                    if (itemData.discounted_price) {
                        const discount = Math.round(
                            (1 - itemData.discounted_price / itemData.price) *
                                100,
                        );
                        priceHtml = `
                                <div class="price-container">
                                    <p class="original-price">${itemData.price}€</p>
                                    <p class="discounted-price">${itemData.discounted_price}€</p>
                                    <span class="discount-badge">${discount}% OFF</span>
                                </div>
                            `;
                    } else {
                        priceHtml = `
                                <div class="price-container">
                                    <p class="discounted-price">${price}€</p>
                                </div>
                            `;
                    }

                    // Build the cart item HTML
                    cartItemElement.innerHTML = `
            <img src="${itemData.image || "images/image.png"}" class="item-image" alt="image">
            <div class="cart-details">
                <div>
                    <h2>${itemData.name || `Item ${id}`}</h2>
                    ${priceHtml}
                </div>
            </div>
                            <div class="price-container">
                                <p class="item-subtotal" style="color: #e74c3c; font-weight: bold; font-size: 1.3em;">€${Number(price * quantity).toLocaleString("en", { minimumFractionDigits: 0, maximumFractionDigits: 2 })}</p>
                            </div>
                            <div class="quantity-controls">
                                <button type="button" class="quantity-btn minus" onclick="adjustQuantity(this, -1)" title="Decrease quantity">-</button>
                                <input type="number" class="item-quantity" value="${quantity}" min="1" onchange="validateQuantity(this)" oninput="validateQuantity(this)">
                                <button type="button" class="quantity-btn plus" onclick="adjustQuantity(this, 1)" title="Increase quantity">+</button>
                            </div>
                            <div class="cart-actions">
                                <button class="remove-btn danger" onclick="removeFromCart('${id}')">Remove</button>
                                <button class="update-btn" style="display: none;" onclick="updateCartItem('${id}')">Update Quantity</button>
                            </div>
                        `;

                    // Add to cart if not already present
                    if (
                        !document.querySelector(`.cart-item[data-id="${id}"]`)
                    ) {
                        cartListElement.appendChild(cartItemElement);
                        console.log(
                            `Added directly fetched item ${id} to cart:`,
                            itemData.name,
                        );
                    }

                    // Update cart total
                    updateCartTotal();
                } catch (error) {
                    console.error(
                        "Error adding directly fetched item to cart:",
                        error,
                    );
                }
            }

            // Initialize when the page loads
            document.addEventListener("DOMContentLoaded", () => {
                createNotificationContainer();
                renderCart();
                updateCartCount();
                updateCheckoutButtonVisibility();

                // Function to enable/disable checkout button based on cart contents
                function updateCheckoutButtonVisibility() {
                    const checkoutButton =
                        document.querySelector(".checkout-btn");
                    if (checkoutButton) {
                        const cart = JSON.parse(
                            localStorage.getItem("cart") || "[]",
                        );
                        if (cart.length > 0) {
                            checkoutButton.style.display = "inline-block";
                            checkoutButton.disabled = false;
                            checkoutButton.style.opacity = "1";
                            checkoutButton.style.cursor = "pointer";
                        } else {
                            checkoutButton.style.display = "inline-block";
                            checkoutButton.disabled = true;
                            checkoutButton.style.opacity = "0.5";
                            checkoutButton.style.cursor = "not-allowed";
                        }
                    }

                    // Check for VIP items to show/hide VIP section
                    const specialCartListElement =
                        document.getElementById("special-cart-list");
                    const hasVipItem = checkForVipItems();
                    if (specialCartListElement) {
                        specialCartListElement.style.display = hasVipItem
                            ? "block"
                            : "none";
                    }
                }

                // Helper function to check if cart has VIP items
                function checkForVipItems() {
                    const cart = JSON.parse(
                        localStorage.getItem("cart") || "[]",
                    );
                    if (Array.isArray(cart) && cart.length > 0) {
                        if (typeof cart[0] !== "object") {
                            // Old format - array of IDs
                            return (
                                cart.includes(1) ||
                                cart.includes("1") ||
                                cart.includes("vip")
                            );
                        } else {
                            // New format - array of objects
                            return cart.some(
                                (item) =>
                                    String(item.id) === "1" ||
                                    String(item.id) === "vip",
                            );
                        }
                    }
                    return false;
                }

                // Debug functionality removed
                // Prevent double notifications on page load
                document
                    .querySelectorAll(".notification")
                    .forEach((n) => removeNotification(n));
            });
        </script>
    </body>
</html>
