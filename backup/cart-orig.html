<!doctype html>
<html>
    <head>
        <!-- Google Consent Mode -->
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag() {
                dataLayer.push(arguments);
            }

            // Výchozí stav: souhlas odepřen, pokud není uložena volba
            if (!localStorage.getItem("cookies-accepted")) {
                gtag("consent", "default", {
                    analytics_storage: "denied",
                });
            } else {
                gtag("consent", "update", {
                    analytics_storage:
                        localStorage.getItem("cookies-accepted") === "granted"
                            ? "granted"
                            : "denied",
                });
            }
        </script>
        <!-- Google Analytics (nenačte se automaticky) -->
        <script
            async
            src="https://www.googletagmanager.com/gtag/js?id=G-SGG2CLM06D"
        ></script>
        <script>
            function loadGoogleAnalytics() {
                gtag("js", new Date());
                gtag("config", "G-SGG2CLM06D");
            }

            // Funkce pro zobrazení/skrytí cookie banneru
            function showCookieBanner() {
                if (!localStorage.getItem("cookies-accepted")) {
                    document.getElementById("cookie-banner").style.display =
                        "flex";
                } else {
                    document.getElementById("cookie-banner").style.display =
                        "none";
                    if (
                        localStorage.getItem("cookies-accepted") === "granted"
                    ) {
                        loadGoogleAnalytics();
                    }
                }
            }

            // Funkce pro přijetí cookies
            function acceptCookies() {
                localStorage.setItem("cookies-accepted", "granted");
                document.getElementById("cookie-banner").style.display = "none";
                gtag("consent", "update", {
                    analytics_storage: "granted",
                });
                loadGoogleAnalytics();
            }

            // Funkce pro odmítnutí cookies
            function declineCookies() {
                localStorage.setItem("cookies-accepted", "denied");
                document.getElementById("cookie-banner").style.display = "none";
                gtag("consent", "update", {
                    analytics_storage: "denied",
                });
            }

            // Zobrazit cookie banner po načtení stránky
            window.addEventListener("DOMContentLoaded", showCookieBanner);
        </script>
        <!-- SEO meta tagy pro Google -->
        <meta
            name="description"
            content="SentrySMP is a Minecraft server focused on providing a safe and enjoyable experience for players of all ages. It is SMP with addons."
        />
        <meta
            name="keywords"
            content="Minecraft, SMP, English, Czech, server, safe, enjoyable, experience, players, vip, premium, exclusive"
        />
        <meta name="author" content="Sentry SMP" />

        <!-- Open Graph pro Facebook, Discord, aj. -->
        <meta property="og:title" content="Sentry SMP" />
        <meta
            property="og:description"
            content="Sentry SMP server is a Minecraft server focused on providing a safe and enjoyable experience for players of all ages. It is SMP with addons."
        />
        <meta
            property="og:image"
            content="https://sentrysmp.eu/images/logo.png"
        />
        <meta property="og:url" content="https://sentrysmp.eu/" />
        <meta property="og:type" content="website" />

        <!-- Twitter Cards (volitelné) -->
        <meta name="twitter:card" content="summary_large_image" />
        <meta name="twitter:title" content="Sentry SMP" />
        <meta
            name="twitter:description"
            content="Sentry SMP server is a Minecraft server focused on providing a safe and enjoyable experience for players of all ages. It is SMP with addons."
        />
        <meta
            name="twitter:image"
            content="https://sentrysmp.eu/images/logo.png"
        />
        <!-- Language settings -->
        <meta http-equiv="content-language" content="en" />
        <meta name="language" content="English" />

        <title>Cart - Sentry SMP</title>
        <meta charset="utf-8" />
        <link rel="stylesheet" href="css/style.css" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="icon" href="images/favicon.png" />
        <style>
            body.dark .header-background {
                background-image: url("images/background-image-dark.png");
            }

            body:not(.dark) .header-background {
                background-image: url("images/background-image.png");
            }

            .quantity-controls {
                display: flex;
                align-items: center;
                justify-content: center;
                margin: 10px 0;
            }

            .quantity-btn {
                background-color: #333;
                color: white;
                border: none;
                width: 25px;
                height: 25px;
                font-size: 16px;
                cursor: pointer;
                border-radius: 4px;
                margin: 0 5px;
            }

            .quantity-btn:hover {
                background-color: #555;
            }

            .quantity-controls span {
                font-size: 16px;
                width: 30px;
                text-align: center;
                display: inline-block;
                padding: 2px 0;
                transition: all 0.3s ease;
                font-weight: bold;
            }

            .quantity-controls button:active + span,
            .quantity-controls button:focus + span {
                transform: scale(1.2);
                color: #2196f3;
            }

            .cart-total {
                margin: 20px 0;
                padding: 10px;
                background-color: #f4f4f4;
                border-radius: 5px;
                text-align: right;
            }

            body.dark .cart-total {
                background-color: #333;
            }
        </style>
    </head>
    <body>
        <nav class="navbar" id="navbar-main"></nav>

        <!-- make hovers for grid items -->
        <header id="header-main"></header>
        <div class="container">
            <div class="main-wrapper">
                <h1 class="main">Cart</h1>
            </div>
            <button class="empty-btn danger" onclick="emptyCart()">
                Empty Cart
            </button>
            <button class="checkout-btn" onclick="location.href='checkout.php'">
                Proceed to Checkout
            </button>
            <div
                style="margin-top: 15px"
                id="special-cart-list"
                class="special-cart"
                style="display: none"
            >
                <h3>VIP Support</h3>
                <div id="vip-cart-items"></div>
            </div>
            <div id="cart-list" class="spawner-grid"></div>
        </div>
        <footer id="footer-main"></footer>
        <script src="js/script.js"></script>
        <script>
            let cart = JSON.parse(localStorage.getItem("cart") || "[]");
            // Convert old format cart to new format if needed
            if (cart.length > 0 && typeof cart[0] !== "object") {
                const newCart = [];
                cart.forEach((id) => {
                    newCart.push({ id: id, quantity: 1, price: 0 });
                });
                cart = newCart;
                saveCart();
            }

            function saveCart() {
                localStorage.setItem("cart", JSON.stringify(cart));
            }

            function renderCart() {
                // Clear the cart list first to avoid duplicate items
                document.getElementById("cart-list").innerHTML = "";
                // Get spawners first
                fetchSpawners().then(() => {
                    // Then get keys
                    fetchKeys().then(() => {
                        // Update checkout button visibility
                        updateCheckoutButtonVisibility();
                        // Calculate and display total price
                        updateCartTotal();
                    });
                });
            }

            function updateCartTotal() {
                let total = 0;
                cart.forEach((item) => {
                    if (typeof item === "object") {
                        total += item.price * item.quantity;
                    }
                });

                // Display total if items exist
                if (total > 0) {
                    const totalElement = document.getElementById("cart-total");
                    if (!totalElement) {
                        const totalDiv = document.createElement("div");
                        totalDiv.id = "cart-total";
                        totalDiv.className = "cart-total";
                        totalDiv.innerHTML = `<h3>Total: ${total}€</h3>`;
                        document
                            .querySelector(".container")
                            .insertBefore(
                                totalDiv,
                                document.querySelector(".checkout-btn"),
                            );
                    } else {
                        totalElement.innerHTML = `<h3>Total: ${total}€</h3>`;
                    }
                } else {
                    const totalElement = document.getElementById("cart-total");
                    if (totalElement) totalElement.remove();
                }
            }

            function updateCheckoutButtonVisibility() {
                const checkoutButton = document.querySelector(".checkout-btn");
                if (checkoutButton) {
                    if (cart.length > 0) {
                        checkoutButton.style.display = "inline-block";
                        checkoutButton.disabled = false;
                    } else {
                        checkoutButton.style.display = "inline-block";
                        checkoutButton.disabled = true;
                        checkoutButton.style.opacity = "0.5";
                        checkoutButton.style.cursor = "not-allowed";
                    }
                }
            }

            function updateItemQuantity(id, delta) {
                const itemIndex = cart.findIndex(
                    (item) => String(item.id) === String(id),
                );
                if (itemIndex !== -1) {
                    const oldQuantity = cart[itemIndex].quantity;
                    const newQuantity = Math.max(1, oldQuantity + delta);
                    cart[itemIndex].quantity = newQuantity;
                    saveCart();

                    // Display a small floating indicator near the button
                    const button = document.querySelector(
                        `button[onclick="updateItemQuantity('${id}', ${delta})"]`,
                    );
                    if (button) {
                        const indicator = document.createElement("span");
                        indicator.textContent = delta > 0 ? "+" + delta : delta;
                        indicator.style.position = "absolute";
                        indicator.style.background =
                            delta > 0 ? "#4CAF50" : "#f44336";
                        indicator.style.color = "white";
                        indicator.style.borderRadius = "50%";
                        indicator.style.width = "20px";
                        indicator.style.height = "20px";
                        indicator.style.textAlign = "center";
                        indicator.style.lineHeight = "20px";
                        indicator.style.fontSize = "12px";
                        indicator.style.opacity = "0.9";
                        indicator.style.transition = "all 0.5s ease-out";

                        const buttonRect = button.getBoundingClientRect();
                        indicator.style.left =
                            buttonRect.left + buttonRect.width / 2 + "px";
                        indicator.style.top = buttonRect.top + "px";
                        document.body.appendChild(indicator);

                        // Animate and remove
                        setTimeout(() => {
                            indicator.style.transform = "translateY(-20px)";
                            indicator.style.opacity = "0";
                            setTimeout(
                                () => document.body.removeChild(indicator),
                                500,
                            );
                        }, 10);
                    }

                    renderCart();

                    // Show detailed feedback to the user
                    const feedbackDiv = document.createElement("div");
                    if (delta > 0) {
                        feedbackDiv.textContent = `Quantity increased from ${oldQuantity} to ${newQuantity}!`;
                    } else if (delta < 0) {
                        feedbackDiv.textContent = `Quantity decreased from ${oldQuantity} to ${newQuantity}!`;
                    }
                    feedbackDiv.style =
                        "position: fixed; top: 20px; right: 20px; background: #4CAF50; color: white; padding: 10px; border-radius: 5px; z-index: 1000;";
                    document.body.appendChild(feedbackDiv);
                    setTimeout(() => {
                        feedbackDiv.style.opacity = "0";
                        feedbackDiv.style.transition = "opacity 0.5s";
                        setTimeout(
                            () => document.body.removeChild(feedbackDiv),
                            500,
                        );
                    }, 1500);
                }
            }

            function fetchSpawners() {
                return fetch("spawners.php")
                    .then((response) => response.text())
                    .then((html) => {
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, "text/html");
                        const allSpawners = doc.querySelectorAll(".spawner");
                        const cartList = document.getElementById("cart-list");
                        const specialCartList =
                            document.getElementById("special-cart-list");
                        const vipCartItems =
                            document.getElementById("vip-cart-items");

                        cartList.innerHTML = "";
                        vipCartItems.innerHTML = "";
                        let hasVipItems = false;

                        // First, check for VIP items (ID 1)
                        const vipItem = cart.find(
                            (item) => String(item.id) === "1",
                        );
                        if (vipItem) {
                            hasVipItems = true;
                            const vipItemDiv = document.createElement("div");
                            vipItemDiv.className = "vip-package";
                            vipItemDiv.innerHTML = `
                              <p>6€ x ${vipItem.quantity} = ${6 * vipItem.quantity}€</p>
                              <div class="quantity-controls">
                                <button class="quantity-btn" onclick="updateItemQuantity('1', -1)">-</button>
                                <span class="quantity-display">${vipItem.quantity}</span>
                                <button class="quantity-btn" onclick="updateItemQuantity('1', 1)">+</button>
                              </div>
                              <button class="remove-btn danger" onclick="removeFromCart('1')">Remove</button>
                              <button onclick="window.location.href='checkout-vip.html'">Proceed To Checkout</button>
                            `;
                            vipCartItems.appendChild(vipItemDiv);
                        }

                        specialCartList.style.display = hasVipItems
                            ? "block"
                            : "none";

                        // Then handle regular spawners
                        allSpawners.forEach((spawner) => {
                            const id = spawner.getAttribute("data-id");
                            // Find the item in cart by id
                            const cartItem = cart.find(
                                (item) => String(item.id) === String(id),
                            );

                            if (cartItem) {
                                const clone = spawner.cloneNode(true);

                                // Find price in the description
                                const description =
                                    clone.querySelector("p").textContent;
                                const priceMatch = description.match(/(\d+)€/);
                                let price = 3; // Default price
                                if (priceMatch) {
                                    price = parseInt(priceMatch[1]);
                                }

                                // Store price in the cart item if not already set
                                if (!cartItem.price) {
                                    cartItem.price = price;
                                    saveCart();
                                }

                                // Add quantity controls and price calculation
                                const quantityControls =
                                    document.createElement("div");
                                quantityControls.className =
                                    "quantity-controls";
                                quantityControls.innerHTML = `
                                    <button class="quantity-btn" onclick="updateItemQuantity('${id}', -1)">-</button>
                                    <span>${cartItem.quantity}</span>
                                    <button class="quantity-btn" onclick="updateItemQuantity('${id}', 1)">+</button>
                                `;

                                // Update price display with quantity
                                const priceElement = clone.querySelector("p");
                                const originalText =
                                    priceElement.innerHTML.replace(
                                        /\d+€/,
                                        `${price}€ x ${cartItem.quantity} = ${price * cartItem.quantity}€`,
                                    );
                                priceElement.innerHTML = originalText;

                                const btn = document.createElement("button");
                                btn.textContent = "Remove";
                                btn.className = "remove-btn danger";
                                btn.type = "button";
                                btn.addEventListener("click", function (e) {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    console.log(
                                        "Remove button clicked for ID:",
                                        id,
                                    );
                                    removeFromCart(id);
                                    return false;
                                });

                                const originalButton =
                                    clone.querySelector("button");
                                if (originalButton) originalButton.remove();

                                clone.appendChild(quantityControls);
                                clone.appendChild(btn);
                                cartList.appendChild(clone);
                            }
                        });
                    });
            }

            function fetchKeys() {
                return fetch("keys.php")
                    .then((response) => response.text())
                    .then((html) => {
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, "text/html");
                        const allKeys = doc.querySelectorAll(".spawner");
                        const cartList = document.getElementById("cart-list");

                        // Handle keys
                        allKeys.forEach((key) => {
                            const id = key.getAttribute("data-id");
                            // Find the item in cart by id
                            const cartItem = cart.find(
                                (item) => String(item.id) === String(id),
                            );

                            if (cartItem) {
                                const clone = key.cloneNode(true);

                                // Find price in the description
                                const description =
                                    clone.querySelector("p").textContent;
                                const priceMatch = description.match(/(\d+)€/);
                                let price = 3; // Default price
                                if (priceMatch) {
                                    price = parseInt(priceMatch[1]);
                                }

                                // Store price in the cart item if not already set
                                if (!cartItem.price) {
                                    cartItem.price = price;
                                    saveCart();
                                }

                                // Add quantity controls and price calculation
                                const quantityControls =
                                    document.createElement("div");
                                quantityControls.className =
                                    "quantity-controls";
                                quantityControls.innerHTML = `
                                    <button class="quantity-btn" onclick="updateItemQuantity('${id}', -1)">-</button>
                                    <span>${cartItem.quantity}</span>
                                    <button class="quantity-btn" onclick="updateItemQuantity('${id}', 1)">+</button>
                                `;

                                // Update price display with quantity
                                const priceElement = clone.querySelector("p");
                                const originalText =
                                    priceElement.innerHTML.replace(
                                        /\d+€/,
                                        `${price}€ x ${cartItem.quantity} = ${price * cartItem.quantity}€`,
                                    );
                                priceElement.innerHTML = originalText;

                                const btn = document.createElement("button");
                                btn.textContent = "Remove";
                                btn.className = "remove-btn danger";
                                btn.addEventListener("click", function (e) {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    console.log(
                                        "Remove button clicked for ID:",
                                        id,
                                    );
                                    removeFromCart(id);
                                    return false;
                                });
                                const originalButton =
                                    clone.querySelector("button");
                                if (originalButton) originalButton.remove();

                                clone.appendChild(quantityControls);
                                clone.appendChild(btn);
                                cartList.appendChild(clone);
                            }
                        });
                    });
            }

            function removeFromCart(id) {
                // Convert id to string to ensure consistent comparison
                const idString = String(id);
                console.log("Removing from cart:", idString);

                // Find the item to get its quantity for the message
                const removedItem = cart.find(
                    (item) => String(item.id) === idString,
                );
                const quantity = removedItem ? removedItem.quantity : 1;

                // Filter the cart to remove the item - make sure we convert both to strings
                cart = cart.filter((item) => String(item.id) !== idString);
                console.log("Cart after removal:", cart);

                // Save the updated cart and re-render
                saveCart();
                renderCart();

                // Initialize checkout button visibility
                updateCheckoutButtonVisibility();

                // Show feedback to the user
                const feedbackDiv = document.createElement("div");
                feedbackDiv.textContent = `Removed ${quantity} item(s) from cart!`;
                feedbackDiv.style =
                    "position: fixed; top: 20px; right: 20px; background: #4CAF50; color: white; padding: 10px; border-radius: 5px; z-index: 1000;";
                document.body.appendChild(feedbackDiv);
                setTimeout(() => {
                    feedbackDiv.style.opacity = "0";
                    feedbackDiv.style.transition = "opacity 0.5s";
                    setTimeout(
                        () => document.body.removeChild(feedbackDiv),
                        500,
                    );
                }, 1500);

                // Prevent default behavior if this is triggered from a button
                return false;
            }

            function emptyCart() {
                if (cart.length === 0) {
                    alert("Cart is already empty!");
                    return;
                }

                // Count total items in cart for message
                let totalItems = 0;
                cart.forEach((item) => {
                    totalItems += item.quantity || 1;
                });

                if (
                    confirm(
                        `Are you sure you want to empty your cart? (${totalItems} items will be removed)`,
                    )
                ) {
                    cart = [];
                    saveCart();
                    renderCart();

                    // Show feedback to the user
                    const feedbackDiv = document.createElement("div");
                    feedbackDiv.textContent = `Cart emptied successfully! (${totalItems} items removed)`;
                    feedbackDiv.style =
                        "position: fixed; top: 20px; right: 20px; background: #4CAF50; color: white; padding: 10px; border-radius: 5px; z-index: 1000;";
                    document.body.appendChild(feedbackDiv);
                    setTimeout(() => {
                        feedbackDiv.style.opacity = "0";
                        feedbackDiv.style.transition = "opacity 0.5s";
                        setTimeout(
                            () => document.body.removeChild(feedbackDiv),
                            500,
                        );
                    }, 1500);

                    // Update checkout button visibility
                    updateCheckoutButtonVisibility();
                }
            }

            renderCart();
        </script>
        <!-- Removed cart-processor.js as its functionality is now in precheckout.php -->
    </body>
</html>
